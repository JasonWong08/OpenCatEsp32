<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run Code防抖测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .console {
            background: #f0f0f0;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }

        button {
            margin: 5px;
            padding: 8px 16px;
        }

        .active {
            background-color: #28a745;
            color: white;
        }

        .error {
            color: red;
        }

        .success {
            color: green;
        }

        .warning {
            color: orange;
        }

        .info {
            color: blue;
        }
    </style>
</head>

<body>
    <h1>Run Code防抖测试</h1>

    <div>
        <button onclick="testRunCode()">测试Run Code</button>
        <button onclick="testQuickConnect()">测试Quick Connect</button>
        <button onclick="setIP19216841()">设置IP为192.168.4.1</button>
        <button onclick="setIP19216850168()">设置IP为192.168.50.168</button>
        <button onclick="setBlockIP19216841()">设置积木IP为192.168.4.1</button>
        <button onclick="setBlockIP19216850168()">设置积木IP为192.168.50.168</button>
        <button onclick="setBlockIPInvalid()">设置积木IP为无效格式</button>
        <button onclick="setBlockIPEmpty()">设置积木IP为空</button>
        <button onclick="clearConsole()">Clear</button>
    </div>

    <div>
        <p>当前IP地址: <span id="currentIP">192.168.4.1</span></p>
        <p>积木IP地址: <span id="blockIP">192.168.4.1</span></p>
        <p>程序运行状态: <span id="programStatus">未运行</span></p>
        <p>上次点击时间: <span id="lastClickTime">-</span></p>
    </div>

    <div id="consoleLog" class="console"></div>

    <script>
        // 模拟全局变量
        let currentDeviceIP = '192.168.4.1';
        let lastRunCodeTime = 0;
        let isProgramRunning = false;
        // 模拟积木块IP地址
        let blockIP = '192.168.4.1';

        // IP地址格式验证函数
        function isValidIPAddress(ip)
        {
            if (!ip || typeof ip !== 'string')
            {
                return false;
            }

            // 检查是否为192.168.4.1
            if (ip === '192.168.4.1')
            {
                return false; // 返回false表示需要quick connect
            }

            // 检查IP地址格式
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipRegex.test(ip);
        }

        // 模拟翻译函数
        function getText(key)
        {
            return {
                "noConnectionBlockError": "错误：请添加一个'Connect with IP'积木块并将代码连接在其下方！",
                "programEndingRestCommand": "程序结束，发送休息指令",
                "restCommandFailed": "休息指令发送失败: ",
                "taskEnded": "任务结束",
                "networkRequestError": "网络请求错误"
            }[key] || key;
        }

        // 模拟quickConnect函数
        async function quickConnect()
        {
            console.log("执行Quick Connect...");
            // 模拟连接过程
            await new Promise(resolve => setTimeout(resolve, 2000));
            console.log("Quick Connect完成");
            return true;
        }

        // 模拟runCode函数
        function runCode()
        {
            const now = Date.now();

            // 防抖检查：如果距离上次点击小于1秒，则不执行
            if (now - lastRunCodeTime < 1000)
            {
                if (typeof showDebug !== 'undefined' && showDebug)
                {
                    console.log(getText("debounceTimeInterval"));
                }
                return;
            }

            // 检查程序是否正在运行
            if (isProgramRunning)
            {
                if (typeof showDebug !== 'undefined' && showDebug)
                {
                    console.log(getText("debounceProgramRunning"));
                }
                return;
            }

            // 检查积木中的IP地址是否需要自动执行quick connect
            if (!isValidIPAddress(blockIP))
            {
                if (typeof showDebug !== 'undefined' && showDebug)
                {
                    console.log(getText("detectedInvalidIP").replace('{ip}', blockIP));
                }
                quickConnect().then(() =>
                {
                    // quick connect完成后，延迟1秒再执行runCode
                    setTimeout(() =>
                    {
                        executeRunCode();
                    }, 1000);
                }).catch((error) =>
                {
                    console.error("Quick connect失败:", error);
                    // 即使quick connect失败，也尝试执行runCode
                    executeRunCode();
                });
                return;
            }

            // 直接执行runCode
            executeRunCode();
        }

        function executeRunCode()
        {
            const now = Date.now();
            lastRunCodeTime = now;
            isProgramRunning = true;

            console.log(getText("programExecutionStarted"));
            updateStatus();

            // 模拟程序执行
            setTimeout(() =>
            {
                console.log(getText("programExecutionCompleted"));
                isProgramRunning = false;
                updateStatus();
            }, 3000);
        }

        // 更新状态显示
        function updateStatus()
        {
            document.getElementById('currentIP').textContent = currentDeviceIP;
            document.getElementById('blockIP').textContent = blockIP;
            document.getElementById('programStatus').textContent = isProgramRunning ? '运行中' : '未运行';
            document.getElementById('lastClickTime').textContent = lastRunCodeTime ? new Date(lastRunCodeTime).toLocaleTimeString() : '-';
        }

        // 设置IP地址
        function setIP19216841()
        {
            currentDeviceIP = '192.168.4.1';
            updateStatus();
            console.log("IP地址已设置为: 192.168.4.1");
        }

        function setIP19216850168()
        {
            currentDeviceIP = '192.168.50.168';
            updateStatus();
            console.log("IP地址已设置为: 192.168.50.168");
        }

        function setBlockIP19216841()
        {
            blockIP = '192.168.4.1';
            updateStatus();
            console.log("积木IP地址已设置为: 192.168.4.1");
        }

        function setBlockIP19216850168()
        {
            blockIP = '192.168.50.168';
            updateStatus();
            console.log("积木IP地址已设置为: 192.168.50.168");
        }

        function setBlockIPInvalid()
        {
            blockIP = 'invalid.ip.address';
            updateStatus();
            console.log("积木IP地址已设置为无效格式: invalid.ip.address");
        }

        function setBlockIPEmpty()
        {
            blockIP = '';
            updateStatus();
            console.log("积木IP地址已设置为空");
        }

        // 测试函数
        function testRunCode()
        {
            console.log("=== 测试Run Code ===");
            runCode();
        }

        function testQuickConnect()
        {
            console.log("=== 测试Quick Connect ===");
            quickConnect();
        }

        // 添加console消息
        function addConsoleMessage(args)
        {
            const logDiv = document.getElementById('consoleLog');
            const time = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');

            const messages = Array.from(args).map(arg =>
            {
                if (typeof arg === 'object')
                {
                    try
                    {
                        return JSON.stringify(arg, null, 2);
                    } catch (e)
                    {
                        return String(arg);
                    }
                }
                return String(arg);
            });

            const messageText = messages.join(' ');
            messageDiv.textContent = `[${time}] ${messageText}`;

            // 根据消息内容添加颜色
            if (messageText.includes('防抖'))
            {
                messageDiv.classList.add('warning');
            } else if (messageText.includes('错误') || messageText.includes('Error'))
            {
                messageDiv.classList.add('error');
            } else if (messageText.includes('成功') || messageText.includes('完成'))
            {
                messageDiv.classList.add('success');
            } else if (messageText.includes('检测到') || messageText.includes('IP'))
            {
                messageDiv.classList.add('info');
            }

            logDiv.appendChild(messageDiv);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 重写console.log
        const originalLog = console.log;
        console.log = function ()
        {
            addConsoleMessage(arguments);
            originalLog.apply(console, arguments);
        };

        // 重写console.warn
        const originalWarn = console.warn;
        console.warn = function ()
        {
            addConsoleMessage(arguments);
            originalWarn.apply(console, arguments);
        };

        // 重写console.error
        const originalError = console.error;
        console.error = function ()
        {
            addConsoleMessage(arguments);
            originalError.apply(console, arguments);
        };

        // 清除console
        function clearConsole()
        {
            document.getElementById('consoleLog').innerHTML = '';
        }

        // 初始化
        updateStatus();
        console.log("Run Code防抖测试页面已加载");
        console.log("测试说明：");
        console.log("1. 快速点击'测试Run Code'按钮测试防抖功能");
        console.log("2. 设置IP为192.168.4.1测试自动Quick Connect");
        console.log("3. 观察程序运行状态和防抖效果");
    </script>
</body>

</html>
